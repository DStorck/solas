# Overview

Quay is a container and application repository/registry service, used to host
artifacts generated by [Jenkins](./jenkins.md). `solas-container` derived
[GitHub](./github/.md) repositories generate container artifacts stored in a
[Quay Container Repository](https://quay.io/repository/). `solas-chart` derived
repositories generate helm chart artifacts which are stored in the
[Quay Application Registry](https://quay.io/application/). Hosting these
artifacts in Quay makes sharing with others easy. This guide will show you how
to create repositories and prepare for Jenkins to take over.

The following assumes a repository which has been duplicated according to the
instructions in the [README](../README.md).

## [Create](https://docs.quay.io/guides/create-repo.html) a repository

Artifacts for the Samsung CNCT organization, are stored in the `samsung_cnct`
namespace. By convention, the name of the artifact depends on where it came
from. For container repositories, e.g. `container-zabra`, the artifact is named
`zabra-container`. For application repositories, e.g. `chart-zabra`, the
artifact is named simply `zabra`. This is done because the application, and not
the container, is generally the artifact we expect users to interact with.

* Go to [quay.io](https://quay.io) and login if you are not already logged in.

* Click the `+` icon in the top right of the page, near your name, and select
`New Repository` ![screenshot](images/quay/create_new_repository.png).

* Choose `samsung_cnct` for the namespace.

* Enter the name of the artifact. For example, `zabra-container` or `zabra`.

* Select `Container Repository`, for `solas-container` derived repositories

* Select `Application Repository`, for `solas-chart` derived repositories

![screenshot](images/quay/cool-application.png)

* Write a helpful description, it will never hurt!

* Make the repository public or private as appropriate.

* Finish creating the repository by clicking `Create Public Repository` or
`Create Private Repository`.

## Create a robot account

A robot account is used to authenticate and authorize access to the repositories
hosted by Quay. Jenkins needs access access to push artifacts to the registry.
We use a different robot account for each repository because this improves
auditing and prevents some mistakes (e.g. a build job accidently publishing to
the wrong repository).

By convention, robot accounts are named after the artifact they are associated
with, and the permissions they grant. Dashes are not allowed in robot names, so
they are replaced by underscores. For example, read/write premissions for
the `zabra-container` artifact  are named `zabra_container_rw`. The same
permissions for `zabra` are `zabra_rw`.

* Go to the `samsung_cnct` robots page here
https://quay.io/organization/samsung_cnct?tab=robots

* Create a new robot account named after the repository and the permissions
granted (e.g. `zabra_container_rw`, `zabra_rw`).

![screenshot](images/quay/robot-page.png)
![screenshot](images/quay/creating-robot.png)

* Grant the robot write access to the container/application repository

![screenshot](images/quay/add-robot-permissions.png)

### Add Kubernetes Secret to Production Cluster for your robot

To allow Jenkins to use the robot to access Quay, a Kubernetes Secret can be
created. This is preferred over other methods of passing secrets because it
allows us to reuse production Kubernetes processes (e.g. monitoring, logging,
auditing, backups, etc.).

By convention, Kubernetes secrets are named after the artifact they give
permissions for, and the permissions they give. For example,
`quay-robot-zabra-container-rw` or `quay-robot-zabra-rw`.

* Log in to the CNCT production cluster using
[these](https://github.com/samsung-cnct/docs/blob/master/cnct/production-kubernetes-cluster.md)
instructions.

* Go to https://quay.io/organization/samsung_cnct?tab=robots and find your
robot.

* For `solas-container` derived repositories,

* Click on Docker Configuration and then download the Docker credentials file
for the robot account ![screenshot](images/jenkins/get-docker-config.png)

* The name of the downloaded file will become the name of the secret file
mounted in the Kubernetes Pod which runs CI/CD for your repository.
**Therefore, you *must* rename that file to `config.json`**

** Create a [Kubernetes Secret](https://kubernetes.io/docs/concepts/configuration/secret/)
to bring this configuration into the cluster. There are several methods
that will work, a simple one is to run:
```
kubectl create secret generic quay-robot-zabra-container-rw --namespace common-jenkins --from-file=./config.json
```

* For `solas-chart` derived repositories,

* Click on Docker Login

** Calculate base64 encoded username and password

```
echo 'samsung_cnct+zabra_r' | base64
echo 'Ea4fFjDreISLoNeWsdEg6PPMLVDh9GQNRROEBJ1G7559MRPJ3SSQFJ4F5FM4CKBS' | base64
```

** Create a [Kubernetes Secret](https://kubernetes.io/docs/concepts/configuration/secret/)
to bring this configuration into the cluster. There are several methods
that will work, a simple one is to run:
```
kubectl create secret generic quay-robot-zabra-rw --from-literal=username=c2Ftc3VuZ19jimN0KkphYnJdX3IK --from-literal=password=E4FDISLNWE6PPMLV9GQNRROEBJ1G7559MRPJ3SSQFJ4F5FM4CKB3YNOC6YVUF0PS
```

Then, if you have not already done so, head to the Jenkinsfile for your
repo, and edit the `secret_name` to be `quay-robot-zabra-container-rw`
or `quay-robot-zabra-rw`
